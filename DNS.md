# 概述

​	域名系统DNS（Domain Name System）是互联网使用的**命名系统**，用来把便于人们使用的机器名字（例如mail.bsa123.com等地址）转换为 IP地址（二进制主机地址）。也就是说，DNS其实就是名字系统。

​	因为用户难以记住32位的二进制主机地址，即使是十进制点分IP的值也不容易记忆。为此，就需要一种能够轻松记忆且唯一映射IP地址的概念，也就是**域名**[^注1.1]，解析这种域名的系统就是DNS，**用于将域名转换为相应的IP地址**。

​	理论上讲，整个互联网可以只使用一个域名服务器，存储互联网上所有的主机名与IP地址的对应关系。但随着互联网规模的迅速扩展，只有一个域名服务器明显是无法快速响应所有请求的，且存在瘫痪风险。为此，互联网就开始采用**层次树状结构**的命名方式，并使用**分布式**的域名系统。

​	互联网的域名系统DNS被设计成为一个**联机分布式数据库**系统，并采用**客户服务器方式**（C/S架构）。DNS使大多数名字都在本地进行解析，仅少量解析需要在互联网上通信，因此DNS系统的效率很高。由于DNS是分布式系统，即使单个计算机出了故障，也不会妨碍整个DNS系统的正常运行。

​	域名到IP地址的解析是由分布在互联网上的许多**域名服务器程序**共同完成。域名服务器程序在专设的节点上运行，而人们也常把运行域名服务器程序的机器称为**域名服务器**。

​	域名到IP地址的**解析过程**的主要如下：

1. 应用进程需要将主机名（域名）解析为IP地址时，该应用进程就**调用解析程序**，成为DNS的一个客户；
2. 该应用进程将需要解析的**域名放在DNS请求报文**中，以**UDP用户数据报方式**[^注1.2]（为了减少开销）**发送到本地域名服务器**；
3. 本地域名服务器在查找域名后，把对应的IP地址放在回答报文中**返回**给应用进程；

​	应用进程获得目的主机IP地址后即可进行通信。但如果本地域名服务器并未找到待解析域名的对应IP地址时，则此域名服务器也会暂时成为DNS中的客户，向其他域名服务器发出查询请求，直到找到为止。详细过程后面讨论。

[^注1.1]:域名的长度并不是固定的，而IP地址的长度是固定的。为此IP数据报为了处理简单，使用的是IP地址。

[^注1.1]:DNS查询请求使用UDP方式，但也有TCP的方式。

# 域名结构

​	现如今互联网采用的是**层次树状结构**的命名方式。采用这种命名方法，任何一个连接在互联网上的主机或路由器，都有一个**唯一的层次结构**的名字，即**域名**[^注2.1]。“**域**”是名字空间中一个可被管理的划分。域还可以划分为子域，而子域还可以继续划分其子域，这样就形成了顶级域、二级域、三级域等等。

​	每一个域名都由**标号**序列组成，而各标号之间用**小数点**隔开。例如，mail.cctv.com 这个域名中，标号mail是三级域名、标号cctv是二级域名、标号com是顶级域名。

DNS规定：

- 域名中的标号都由英文字母（但也有中文的域名）和数字组成，每个表号**不超过63个字符**，**不区分大小写**；
- 标号中除连接字符（**-**，即减号）外不能使用其他的标点符号；
- 级别最低的域名写在最左边，级别最高写在最右边；
- 由多个标号组成的完整域名总共不超过255个字符；



**顶级域名**TLD（Top Level Domain）可分为三大类：

- **国家顶级域名nTLD**：采用ISO 3166的规定。如，cn表示中国，us表示美国等。国家顶级域名又常记为ccTLD（cc为country-code）。
- **通用顶级域名gTLD**：通用的顶级域名，表示一些机构或部门。如：com（公司企业）、net（网络服务机构）、org（非营利性组织）、int（国际组织）等。
- **基础结构域名**：这种域名只有一个，即 **arpa**，**用于反向域名解析**，因此又称为反向域名。

**PS**：自2011年后，ICANN允许任何公司、机构申请新的顶级域。但申请费很高。



​	**二级域名**是在顶级域名确定的基础下确定的域名，三级域名同理。由此，不同的上级域的同级域名是可以重复的，不同级域名也是可以重复的。我们不妨以多叉树想象域名系统层次结构，即域名数。其中域名树的叶子节点就是单台计算机的名字，无法再往下划分子域。

​	在国家顶级域名下注册的二级域名均由该国家自行决定。我国把二级域名划分为“**类别域名**”和“**行政区域名**”两类：

- **类别域名**：ac（科研机构）、com（企业公司）、edu（教育机构）、gov（政府机构）、mil（国防机构）、net（提供互联网络服务的机构）、org（非营利性组织），可能还有更新未列出；
- **行政区域名**：适用于我国的各省、自治区、直辖市。例如 bj（北京市）等；

[^注2.1]:需要注意的是，域名只是一个逻辑概念，并不代表计算机所在的物理地点。

# 域名服务器

​	上述的域名结构是抽象的，分布在各地的域名服务器则是域名系统的具体实现。为了避免域名服务器数量过多（每一个域对应一个域名服务器的数量超越想象），导致域名系统的运行效率降低，引入了“**区**”的概念。

​	**区是指一个服务器所负责管辖的（或有权限的）范围**。每个单位（域）根据具体情况来划分区，但在一个区中的所有节点必须是能够连通的。每一个区设置相应的**权限域名服务器**，用来保存该区中的所有主机域名到IP地址的映射。也就是说区是域名服务器实际管辖的范围。

​	域和区的关系是包含关系，区可以等于或小于域，但一定不能大于域。有前述可以知道，**域名服务器也存在树状层级结构的关系**。

​	每一个域名服务器都只对域名体系中的一部分管辖。根据域名服务器的管辖范围，可以把域名服务器划分为以下四中不同类型：

- **根域名服务器**：

    ​	根域名服务器是最高层次的域名服务器。**所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址。本地域名服务器一旦无法解析一个域名时，就首先求助于根据域名服务器**。由此可以看出根域名服务器的重要性。

    ​	互联网中的根域名服务器只使用**13**个不同IP地址的域名（即使根域名服务器超过这个数量），但并不意味着根域名服务器是由13台机器所组成。13个不同IP地址的域名组成13组根域名服务器，同一组的根域名服务器使用同一个域名的根域名服务器[^注3.1]，称为**镜像根服务器**。这13组根域名服务器分布世界各地，能够提供可靠的解析域名服务。

    ​	根域名服务器采用**任播**[^注3.2]技术，因此当DNS客户向某个根域名服务器的IP地址发出查询报文时，互联网上的路由器就能找到离这个DNS客户最近的一个根域名服务器。这不仅加快了DNS的查询过程，也更加合理地利用了互联网资源。

    ​	需要注意的是，大多数情况下，根域名服务器根本不将域名解析成IP地址（根域名服务器也没有存储这些信息），而是告诉本地域名服务器下一步应当找哪个顶级域名服务器进行查询，后面详细介绍。

- **顶级域名服务器**：

    ​	这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。当收到DNS查询请求时，就给出相应的回答（可能是最后的结果，也可能是下一步应当找的域名服务器的IP地址）。

- **权限域名服务器**：

    ​	前面已经介绍过该服务器，是负责一个区范围的域名服务器。当一个权限域名服务器还不能给出最后的查询应答时，就会告诉发出查询请求的DNS客户，下一步应当找哪一个权限域名服务器。

- **本地域名服务器**：

    ​	本地域名服务器不属于域名服务器树状层次结构，像是客户主机与DNS系统的中间件。当一台主机发出DNS查询请求时，这个查询请求报文就发送给本地域名服务器。本地域名服务器的管辖范围很小，可以是一个大学或大学里的一个系的主机，有时也被称为**默认域名服务器**。本地域名服务器离用户较近，一般不超过几个路由器的距离。当客户主机与其查询的主机是属于同一个**本地ISP**时，该本地域名服务器立即就能将所查询的主机名转换为IP地址并作查询应答。

​	为了提高域名服务器的可靠性，DNS系统采用集群的方式构建服务器。使用主从模式保证数据的一致性。



​	**个人总结**：总的来说，一个区只有一个服务器，称为**权限域名服务器**，该服务器保存的是该区的IP地址到主机域名的映射。域和区的关系是抽象和实现的关系，也类似郡县制的关系。从各级域名服务器的工作流程也能看出，当上一级域名服务器无法应答DNS查询请求时，就会告诉DNS客户下一步该去请求哪个域名服务器。这种工作流程与双亲委派模型非常类似，同样是找祖先且向下处理。但与双亲委派模型不同的是，DNS域名服务器会将请求交给同级的域名服务器，且查询过程是“迭代查询”和递归查询相结合。

# 域名解析过程

​	在学习域名解析过程前，需要了解两种查询方式：**递归查询**和**迭代查询**，一种策略：**高速缓存**。

- **递归查询**：

    ​	递归查询的方式和递归思想一样，如果得不到结果，就将请求继续往下转发，直到递归条件结束。递归查询在域名解析过程的表现为：如果处理查询请求的域名服务器无法处理该请求，则转发该请求，只需等待最后结果，以此类推直至解析完成并返回结果（可能失败）。由此看来，递归查询中的域名服务器都只会发送一次DNS请求。

- **迭代查询**：

    ​	迭代查询不同于递归查询，当本地域名服务器无法解析域名时，那么本地域名服务器会以DNS客户的身份去请求其他域名服务器（首先请求根域名服务器），其他域名服务器要么返回结果，要么告诉本地域名下一步该请求哪个域名服务器。由此看来，迭代查询的本地域名服务器会发送多次DNS请求。

    > **Tip**：迭代查询中，本地域名服务器的请求对象的“等级”是从高级到低级的顺序，到权限域名服务器后，就是平级了。

- **高速缓存**：

    ​	用来存放最近查询过的域名以及从何处获得域名映射信息的记录，是提高DNS查询效率、减轻域名服务器负荷、减少互联网上的DNS查询报文数量的策略。缓存中的映射记录都有时间限制（因为域名到IP的映射会变化），超过时间的记录会被删去，而这个时间主要是由权限域名服务器指明的有效时间。

**DNS查询过程**：

​	假设现在有 主机A，本地域名服务器B，根域名服务器G，顶级域名服务器D，权限域名服务器Q，则DNS查询过程如下（只用字母表示）：

1. **A** 向 **B** 发送DNS查询请求；
2. **B** 接受请求并尝试解析，如果失败则执行步骤3，否则执行步骤15；
3. **B** 根据查询请求报文中要求的查询方式进行查询（这里假设是递归查询）；
4. **B** 作为DNS客户向 **G** 发送查询请求；
5. **G** 接受请求并查看缓存，如果缓存中有该映射则执行步骤14，否则执行步骤6；
6. **G** 作为DNS客户向 **D** 发送查询请求；
7. **D** 接受请求并查看缓存，如果缓存中有该映射则执行步骤13，否则执行步骤8；
8. **D** 作为DNS客户向 **Q** 发送查询请求；
9. **Q** 接受请求并解析，如果失败则执行步骤10，否则执行步骤12；
10. **Q** 作为DNS客户向其他 **Q** 发送查询请求；
11. 递归执行步骤9直至有结果（可能失败），并将查询结果回传；
12. **Q** 将查询结果发送给 **D**；
13. **D** 将查询结果发送给 **G**；
14. **G** 将查询结果发送给 **B**；
15. **B** 将查询结果发送给 **A**；



迭代查询过程不再列出，无非就是谁作为客户去转发查询请求而已。

[^注3.1]:镜像跟服务器可能由多台机器组成。
[^注3.2]:任播的IP数据报的终点是一组在不同地点的主机，但具有相同的IP地址。IP数据报交付离源点最近的一台主机。

# 参考资料

《计算机网络》（第7版）——谢希仁著